*** Settings ***
Library           ../../../../Resources/uxin_request.py
Library           ../../../../Resources/uxin_live.py
Library           ../../../../Resources/tools_library.py
Variables         ../../../../Resources/global_config.py
Resource          ../../../../Resources/db_operation.txt
Resource          ../../../../Resources/check_operation.txt
Library           ../../../../Resources/redis_library.py

*** Test Cases ***
follow_success
    [Tags]    normal
    #关注成功
    #初始化数据
    ${uid1}=    get_uid    1352245723
    ${uid2}=    get_uid    1352245724
    ${datas}=    create dictionary    fromUid=${uid1}    toUid=${uid2}
    ${ac}=    get_token    1352245723
    ${headers}=    Set Variable    ${ac};_c=1
    #取消关注
    ${datas}=    create dictionary    fromUid=${uid1}    toUid=${uid2}
    ${headers}=    Set Variable    ${ac};_c=1
    #调用取消关注接口
    ${resp}=    post_general    ${live_userrelation_url}    unfollow    headers=${headers}    datas=${datas}
    #获取redis关注数
    ${redis_result_attention_cnt_28}=    redis_query    get user_relation_attentioncnt__${uid1}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    ${redis_result_follow_cnt28}=    redis_query    get user_relation_followcnt__${uid1}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    ${redis_result_attention_cnt_26}=    redis_query    get user_relation_attentioncnt__${uid2}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    ${redis_result_follow_cnt26}=    redis_query    get user_relation_followcnt__${uid2}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    #调用关注接口
    ${resp}=    post_general    ${live_userrelation_url}    follow    headers=${headers}    datas=${datas}
    ${content}=    utf_to_unicode    ${resp.content}
    #打印结果，用于调试
    log    ${content}
    #校验请求成功
    Should Contain    ${content}    "code":200,"msg":"操作成功"
    #校验db更新成功
    ${db_result_att}=    db_pymysql_query    select * from user_attention where from_uid=${uid1} and to_uid=${uid2}    60.205.59.6    db=uxinlive
    ${db_result_att}=    Convert To String    ${db_result_att}
    should contain many    ${db_result_att}    ${uid1}    ${uid2}
    ${db_result_follow}=    db_pymysql_query    select * from user_follow where from_uid=${uid1} and to_uid=${uid2}    60.205.59.6    db=uxinlive
    ${db_result_follow}=    Convert To String    ${db_result_follow}
    should contain many    ${db_result_follow}    ${uid1}    ${uid2}
    #校验更新redis关注列表及粉丝列表
    ${redis_result_attention}=    redis_query    ZREVRANGE user_relation_attention__${uid1} 0 0    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    Should Contain    ${redis_result_attention}    ${uid2}
    ${redis_result_follow}=    redis_query    ZREVRANGE user_relation_follow__${uid2} 0 0    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    Should Contain    ${redis_result_follow}    ${uid1}
    #校验关注数及粉丝数加1
    ${redis_result_attention_cnt_28_after}=    redis_query    get user_relation_attentioncnt__${uid1}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    Should Be Equal As Numbers    ${redis_result_attention_cnt_28_after}    1
    ${redis_result_follow_cnt28_after}=    redis_query    get user_relation_followcnt__${uid1}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    Should Be Equal    ${redis_result_follow_cnt28_after}    ${redis_result_follow_cnt28}
    ${redis_result_attention_cnt_26_after}=    redis_query    get user_relation_attentioncnt__${uid2}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    Should Be Equal    ${redis_result_attention_cnt_26_after}    ${redis_result_attention_cnt_26}
    ${redis_result_follow_cnt26_after}=    redis_query    get user_relation_followcnt__${uid2}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    Should Be Equal As Numbers    ${redis_result_follow_cnt26_after}    1

follow_fail_fromuid与token不一致
    [Tags]    normal
    #关注成功
    #初始化数据
    ${datas}=    create dictionary    fromUid=1697827201028    toUid=1697827201026
    ${ac}=    get_token    1352245723
    ${headers}=    Set Variable    ${ac};_c=1
    #调用关注接口
    ${resp}=    post_general    ${live_userrelation_url}    follow    headers=${headers}    datas=${datas}
    ${content}=    utf_to_unicode    ${resp.content}
    #打印结果，用于调试
    log    ${content}
    #校验请求失败
    Should Contain    ${content}    "code":1100,"msg":"登录用户id与关注人id不一致"

follow_repeat
    [Tags]    normal
    #关注成功
    #初始化数据
    ${uid1}=    get_uid    1352245723
    ${uid2}=    get_uid    1352245724
    ${datas}=    create dictionary    fromUid=${uid1}    toUid=${uid2}
    ${ac}=    get_token    1352245723
    ${headers}=    Set Variable    ${ac};_c=1
    #取消关注
    ${datas}=    create dictionary    fromUid=${uid1}    toUid=${uid2}
    ${headers}=    Set Variable    ${ac};_c=1
    #调用取消关注接口
    ${resp}=    post_general    ${live_userrelation_url}    unfollow    headers=${headers}    datas=${datas}
    #获取redis关注数
    ${redis_result_attention_cnt_28}=    redis_query    get user_relation_attentioncnt__${uid1}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    ${redis_result_follow_cnt28}=    redis_query    get user_relation_followcnt__${uid1}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    ${redis_result_attention_cnt_26}=    redis_query    get user_relation_attentioncnt__${uid2}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    ${redis_result_follow_cnt26}=    redis_query    get user_relation_followcnt__${uid2}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    #调用关注接口
    ${resp}=    post_general    ${live_userrelation_url}    follow    headers=${headers}    datas=${datas}
    ${resp}=    post_general    ${live_userrelation_url}    follow    headers=${headers}    datas=${datas}
    ${content}=    utf_to_unicode    ${resp.content}
    #打印结果，用于调试
    log    ${content}
    #校验请求成功
    Should Contain    ${content}    "code":1103,"msg":"重复关注"
    #校验db更新成功
    ${db_result_att}=    db_pymysql_query    select * from user_attention where from_uid=${uid1} and to_uid=${uid2}    60.205.59.6    db=uxinlive
    ${db_result_att}=    Convert To String    ${db_result_att}
    should contain many    ${db_result_att}    ${uid1}    ${uid2}
    ${db_result_follow}=    db_pymysql_query    select * from user_follow where from_uid=${uid1} and to_uid=${uid2}    60.205.59.6    db=uxinlive
    ${db_result_follow}=    Convert To String    ${db_result_follow}
    should contain many    ${db_result_follow}    ${uid1}    ${uid2}
    #校验更新redis关注列表及粉丝列表
    ${redis_result_attention}=    redis_query    ZREVRANGE user_relation_attention__${uid1} 0 0    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    Should Contain    ${redis_result_attention}    ${uid2}
    ${redis_result_follow}=    redis_query    ZREVRANGE user_relation_follow__${uid2} 0 0    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    Should Contain    ${redis_result_follow}    ${uid1}
    #校验关注数及粉丝数加1
    ${redis_result_attention_cnt_28_after}=    redis_query    get user_relation_attentioncnt__${uid1}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    Should Be Equal As Numbers    ${redis_result_attention_cnt_28_after}    ${${redis_result_attention_cnt_28} + 1}
    ${redis_result_follow_cnt28_after}=    redis_query    get user_relation_followcnt__${uid1}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    Should Be Equal    ${redis_result_follow_cnt28_after}    ${redis_result_follow_cnt28}
    ${redis_result_attention_cnt_26_after}=    redis_query    get user_relation_attentioncnt__${uid2}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    Should Be Equal    ${redis_result_attention_cnt_26_after}    ${redis_result_attention_cnt_26}
    ${redis_result_follow_cnt26_after}=    redis_query    get user_relation_followcnt__${uid2}    redishost=60.205.59.6    redisport=${6321}    password=uxin001
    Should Be Equal As Numbers    ${redis_result_follow_cnt26_after}    ${${redis_result_follow_cnt26} + 1}

follow_unexist_uid_fail
    [Tags]    normal
    #关注成功
    #初始化数据
    ${uid1}=    get_uid    1352245723
    ${uid2}=    set Variable    12345
    ${datas}=    create dictionary    fromUid=${uid1}    toUid=${uid2}
    ${ac}=    get_token    1352245723
    ${headers}=    Set Variable    ${ac};_c=1
    #调用关注接口
    ${resp}=    post_general    ${live_userrelation_url}    follow    headers=${headers}    datas=${datas}
    ${content}=    utf_to_unicode    ${resp.content}
    #打印结果，用于调试
    log    ${content}
    #校验请求成功
    Should Contain    ${content}    "code":1013,"msg":"用户不存在"
    #校验db更新成功
    ${db_result_att}=    db_pymysql_query    select * from user_attention where from_uid=${uid1} and to_uid=${uid2}    60.205.59.6    db=uxinlive
    should Be Empty    ${db_result_att}
